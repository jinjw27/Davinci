<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¤ë¹ˆì¹˜ ì½”ë“œ (Da Vinci Code) - ì¶”ë¦¬ ê²Œì„</title>
    <style>
        /* ===== ì „ì—­ ìŠ¤íƒ€ì¼ ì„¤ì • ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #ffffff;
            padding: 20px;
        }

        /* ===== í—¤ë” ì˜ì—­ ===== */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.2rem;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.95rem;
            color: #a0a0a0;
        }

        /* ===== ë©”ì¸ ì»¨í…Œì´ë„ˆ (2:1 ë ˆì´ì•„ì›ƒ) ===== */
        .main-container {
            display: flex;
            gap: 20px;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* ===== ê²Œì„ ì˜ì—­ (ì™¼ìª½ 2/3) ===== */
        .game-area {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* ===== ê²Œì„ ìƒíƒœ ì •ë³´ íŒ¨ë„ ===== */
        .game-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 12px 20px;
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.8rem;
            color: #a0a0a0;
            margin-bottom: 3px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4ecca3;
        }

        .info-value.player-turn {
            color: #4ecca3;
        }

        .info-value.ai-turn {
            color: #e94560;
        }

        /* ===== ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ ===== */
        #gameCanvas {
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            background: linear-gradient(180deg, #2d3436 0%, #1e272e 100%);
            width: 100%;
        }

        /* ===== ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì˜ì—­ ===== */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            font-size: 0.9rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ecca3, #44bd93);
            color: #1a1a2e;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 204, 163, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #e94560, #c73e54);
            color: #ffffff;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ===== ì¶”ë¦¬ ì…ë ¥ ì˜ì—­ ===== */
        .guess-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
        }

        .guess-panel.active {
            display: block;
        }

        .guess-input {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .guess-input label {
            font-size: 0.9rem;
        }

        .guess-input select {
            padding: 8px 12px;
            font-size: 0.95rem;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a2e;
        }

        /* ===== ì‚¬ì´ë“œ íŒ¨ë„ (ì˜¤ë¥¸ìª½ 1/3) ===== */
        .side-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 300px;
        }

        /* ===== AI ë§í’ì„  ì˜ì—­ ===== */
        .ai-bubble-container {
            background: rgba(233, 69, 96, 0.1);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(233, 69, 96, 0.3);
            min-height: 120px;
        }

        .ai-bubble-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .ai-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #e94560, #c73e54);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .ai-name {
            font-weight: bold;
            color: #e94560;
        }

        .ai-bubble {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border-top-left-radius: 5px;
            padding: 12px 15px;
            position: relative;
            margin-left: 10px;
            animation: fadeIn 0.3s ease;
        }

        .ai-bubble::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 10px;
            border-width: 8px;
            border-style: solid;
            border-color: transparent rgba(255, 255, 255, 0.1) transparent transparent;
        }

        .ai-bubble.thinking {
            color: #74b9ff;
        }

        .ai-bubble.attack {
            color: #e94560;
            font-weight: bold;
        }

        .ai-bubble.success {
            color: #4ecca3;
        }

        .ai-bubble.fail {
            color: #fdcb6e;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== ë¡œê·¸ íŒ¨ë„ ===== */
        .log-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-header {
            font-weight: bold;
            color: #4ecca3;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .log-entry {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.success {
            color: #4ecca3;
        }

        .log-entry.fail {
            color: #e94560;
        }

        .log-entry.info {
            color: #74b9ff;
        }

        /* ===== ê·œì¹™ ì„¤ëª… ëª¨ë‹¬ ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #2d3436, #1e272e);
            border-radius: 20px;
            padding: 25px;
            max-width: 550px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-content h2 {
            color: #e94560;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .modal-content h3 {
            color: #4ecca3;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .modal-content p {
            margin-bottom: 10px;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .modal-content ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .modal-content li {
            margin-bottom: 6px;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .close-modal {
            margin-top: 15px;
            width: 100%;
        }
    </style>
</head>

<body>
    <!-- í—¤ë” ì˜ì—­ -->
    <div class="header">
        <h1>ğŸ´ ë‹¤ë¹ˆì¹˜ ì½”ë“œ</h1>
        <p>ìƒëŒ€ë°©ì˜ ìˆ«ìë¥¼ ì¶”ë¦¬í•˜ì—¬ ëª¨ë“  ì¹´ë“œë¥¼ ê³µê°œí•˜ë¼!</p>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container">
        <!-- ê²Œì„ ì˜ì—­ (ì™¼ìª½ 2/3) -->
        <div class="game-area">
            <!-- ê²Œì„ ìƒíƒœ ì •ë³´ -->
            <div class="game-info">
                <div class="info-item">
                    <div class="info-label">í˜„ì¬ í„´</div>
                    <div class="info-value" id="currentTurn">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ë¼ìš´ë“œ</div>
                    <div class="info-value" id="roundNumber">1</div>
                </div>
                <div class="info-item">
                    <div class="info-label">í”Œë ˆì´ì–´ ê³µê°œ</div>
                    <div class="info-value" id="playerRevealed">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">AI ê³µê°œ</div>
                    <div class="info-value" id="aiRevealed">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ë‚¨ì€ ë±</div>
                    <div class="info-value" id="deckRemaining">-</div>
                </div>
            </div>

            <!-- ìº”ë²„ìŠ¤ -->
            <canvas id="gameCanvas" width="800" height="480"></canvas>

            <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
            <div class="controls">
                <button class="btn btn-primary" id="btnNewGame">ìƒˆ ê²Œì„</button>
                <button class="btn btn-primary" id="btnDrawCard" disabled>ì¹´ë“œ ë½‘ê¸°</button>
                <button class="btn btn-secondary" id="btnRules">ê²Œì„ ê·œì¹™</button>
            </div>

            <!-- ì¶”ë¦¬ íŒ¨ë„ -->
            <div class="guess-panel" id="guessPanel">
                <div class="guess-input">
                    <label>ì¹´ë“œ ìœ„ì¹˜:</label>
                    <select id="cardPosition"></select>
                    <label>ì¶”ë¦¬ ìˆ«ì:</label>
                    <select id="guessNumber">
                        <option value="-1">- (ì¡°ì»¤)</option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                    </select>
                    <button class="btn btn-primary" id="btnGuess">ì¶”ë¦¬í•˜ê¸°</button>
                    <button class="btn btn-secondary" id="btnPass">í„´ ë„˜ê¸°ê¸°</button>
                </div>
            </div>
        </div>

        <!-- ì‚¬ì´ë“œ íŒ¨ë„ (ì˜¤ë¥¸ìª½ 1/3) -->
        <div class="side-panel">
            <!-- AI ë§í’ì„  -->
            <div class="ai-bubble-container">
                <div class="ai-bubble-header">
                    <div class="ai-avatar">ğŸ¤–</div>
                    <span class="ai-name">AI ëŒ€ì „ ìƒëŒ€</span>
                </div>
                <div class="ai-bubble" id="aiBubble">
                    ê²Œì„ì„ ì‹œì‘í•´ì£¼ì„¸ìš”!
                </div>
            </div>

            <!-- ê²Œì„ ë¡œê·¸ -->
            <div class="log-panel" id="logPanel">
                <div class="log-header">ğŸ“‹ ê²Œì„ ë¡œê·¸</div>
            </div>
        </div>
    </div>

    <!-- ê·œì¹™ ëª¨ë‹¬ -->
    <div class="modal" id="rulesModal">
        <div class="modal-content">
            <h2>ğŸ´ ë‹¤ë¹ˆì¹˜ ì½”ë“œ ê²Œì„ ê·œì¹™</h2>
            <p><strong>ê²Œì„ ëª©í‘œ:</strong> ìƒëŒ€ë°©ì˜ ëª¨ë“  ì¹´ë“œ ìˆ«ìë¥¼ ë§ì¶° ê³µê°œì‹œí‚¤ë©´ ìŠ¹ë¦¬!</p>

            <h3>ì¹´ë“œ êµ¬ì„±</h3>
            <ul>
                <li>0~11ê¹Œì§€ ìˆ«ì ì¹´ë“œ (í‘/ë°± ê° 12ì¥, ì´ 24ì¥)</li>
                <li><strong>ì¡°ì»¤ 2ì¥</strong> (í‘/ë°± ê° 1ì¥) - í‘œì‹œ: "-"</li>
                <li>ê° í”Œë ˆì´ì–´ëŠ” ì‹œì‘ ì‹œ 4ì¥ì”© ë°›ìŒ</li>
            </ul>

            <h3>ì¹´ë“œ ì •ë ¬ ê·œì¹™</h3>
            <ul>
                <li>ìˆ«ìëŠ” ì™¼ìª½â†’ì˜¤ë¥¸ìª½ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬</li>
                <li>ê°™ì€ ìˆ«ì: ê²€ì€ìƒ‰ì´ ì™¼ìª½</li>
                <li><strong>ì¡°ì»¤:</strong> ì•„ë¬´ ìœ„ì¹˜ë‚˜ ê°€ëŠ¥ (ë‹¨, ì¡°ì»¤ë¼ë¦¬ ë¶™ì–´ìˆìœ¼ë©´ í°ìƒ‰ì´ ì˜¤ë¥¸ìª½)</li>
            </ul>

            <h3>ê²Œì„ ì§„í–‰</h3>
            <ul>
                <li><strong>ì¹´ë“œ ë½‘ê¸°:</strong> ë±ì—ì„œ 1ì¥ ë½‘ì•„ íŒ¨ì— ì¶”ê°€</li>
                <li><strong>ì¶”ë¦¬í•˜ê¸°:</strong> ìƒëŒ€ ì¹´ë“œ ì„ íƒ í›„ ìˆ«ì ì¶”ë¦¬</li>
                <li><strong>ì„±ê³µ:</strong> ì¹´ë“œ ê³µê°œ, ì—°ì† ì¶”ë¦¬ ê°€ëŠ¥</li>
                <li><strong>ì‹¤íŒ¨:</strong> ë‚´ ìƒˆ ì¹´ë“œ ê³µê°œ, í„´ ë„˜ê¹€</li>
            </ul>

            <h3>ìŠ¹ë¦¬ ì¡°ê±´</h3>
            <p>ìƒëŒ€ ì¹´ë“œë¥¼ ëª¨ë‘ ê³µê°œì‹œí‚¤ë©´ ìŠ¹ë¦¬!</p>

            <button class="btn btn-primary close-modal" id="closeRules">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // ========================================
        // ë‹¤ë¹ˆì¹˜ ì½”ë“œ ê²Œì„ - ì¡°ì»¤ í¬í•¨ ë²„ì „
        // ========================================

        // ===== ê²Œì„ ìƒìˆ˜ =====
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 480;
        const CARD_WIDTH = 55;
        const CARD_HEIGHT = 85;
        const CARD_GAP = 8;

        // ì¡°ì»¤ ìˆ«ì ê°’ (-1ë¡œ í‘œí˜„)
        const JOKER_VALUE = -1;

        // ===== ê²Œì„ ìƒíƒœ ê´€ë¦¬ =====
        const gameState = {
            deck: [],
            playerHand: [],
            aiHand: [],
            currentTurn: 'player',
            phase: 'waiting',
            round: 1,
            drawnCard: null,
            gameOver: false,
            winner: null,
            // ì¡°ì»¤ ë°°ì¹˜ ì •ë³´ (ê° í”Œë ˆì´ì–´ê°€ ì¡°ì»¤ë¥¼ ì–´ë””ì— ë°°ì¹˜í–ˆëŠ”ì§€)
            playerJokerPositions: [],  // ì¡°ì»¤ê°€ ë“¤ì–´ê°„ sortValueë“¤
            aiJokerPositions: []
        };

        // ìº”ë²„ìŠ¤ & ì»¨í…ìŠ¤íŠ¸
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // DOM ìš”ì†Œ
        const btnNewGame = document.getElementById('btnNewGame');
        const btnDrawCard = document.getElementById('btnDrawCard');
        const btnRules = document.getElementById('btnRules');
        const btnGuess = document.getElementById('btnGuess');
        const btnPass = document.getElementById('btnPass');
        const guessPanel = document.getElementById('guessPanel');
        const cardPositionSelect = document.getElementById('cardPosition');
        const guessNumberSelect = document.getElementById('guessNumber');
        const rulesModal = document.getElementById('rulesModal');
        const closeRules = document.getElementById('closeRules');
        const logPanel = document.getElementById('logPanel');
        const aiBubble = document.getElementById('aiBubble');

        // =========================================================
        // ì¹´ë“œ í´ë˜ìŠ¤
        // - number: 0-11 ë˜ëŠ” -1(ì¡°ì»¤)
        // - color: 'black' ë˜ëŠ” 'white'
        // - revealed: ê³µê°œ ì—¬ë¶€
        // - placedSortValue: ì¡°ì»¤ì˜ ê²½ìš° ë°°ì¹˜ëœ ìœ„ì¹˜ ê°’
        // =========================================================
        class Card {
            constructor(number, color) {
                this.number = number;
                this.color = color;
                this.revealed = false;
                this.placedSortValue = null; // ì¡°ì»¤ ë°°ì¹˜ ìœ„ì¹˜
            }

            isJoker() {
                return this.number === JOKER_VALUE;
            }

            /**
             * ì •ë ¬ ê°’ ê³„ì‚°
             * - ì¼ë°˜ ì¹´ë“œ: number * 2 + (white ? 1 : 0)
             * - ì¡°ì»¤: placedSortValue ì‚¬ìš© (ë°°ì¹˜ ì‹œ ê²°ì •)
             */
            getSortValue() {
                if (this.isJoker() && this.placedSortValue !== null) {
                    return this.placedSortValue;
                }
                return this.number * 2 + (this.color === 'white' ? 1 : 0);
            }

            getDisplayText() {
                return this.isJoker() ? '-' : this.number.toString();
            }
        }

        // =========================================================
        // ë± ì´ˆê¸°í™”: 0-11 ìˆ«ì ì¹´ë“œ + í‘ë°± ì¡°ì»¤
        // ì´ 26ì¥ (ìˆ«ì 24ì¥ + ì¡°ì»¤ 2ì¥)
        // =========================================================
        function initializeDeck() {
            const deck = [];
            // ìˆ«ì ì¹´ë“œ ì¶”ê°€
            for (let i = 0; i <= 11; i++) {
                deck.push(new Card(i, 'black'));
                deck.push(new Card(i, 'white'));
            }
            // ì¡°ì»¤ ì¶”ê°€
            deck.push(new Card(JOKER_VALUE, 'black'));
            deck.push(new Card(JOKER_VALUE, 'white'));

            return shuffleDeck(deck);
        }

        // Fisher-Yates ì…”í”Œ
        function shuffleDeck(deck) {
            const shuffled = [...deck];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // =========================================================
        // ì¡°ì»¤ ë°°ì¹˜ ìœ„ì¹˜ ê²°ì •
        // - ì¡°ì»¤ëŠ” ì–´ëŠ ìœ„ì¹˜ë“  ë°°ì¹˜ ê°€ëŠ¥
        // - ë‹¨, ì¡°ì»¤ë¼ë¦¬ ë¶™ì–´ìˆìœ¼ë©´ í° ì¡°ì»¤ê°€ ì˜¤ë¥¸ìª½
        // =========================================================
        function assignJokerPosition(hand, jokerCard) {
            // í˜„ì¬ íŒ¨ì—ì„œ ì‚¬ìš© ì¤‘ì¸ sortValueë“¤
            const usedValues = hand.filter(c => !c.isJoker() || c.placedSortValue !== null)
                .map(c => c.getSortValue());

            // ê°€ëŠ¥í•œ ìœ„ì¹˜ ì°¾ê¸° (0.5 ë‹¨ìœ„ë¡œ ì‚¬ì´ì‚¬ì´ ë°°ì¹˜ ê°€ëŠ¥)
            const possiblePositions = [];

            for (let i = -1; i <= 24; i += 0.5) {
                if (!usedValues.includes(i)) {
                    possiblePositions.push(i);
                }
            }

            // AIëŠ” ëœë¤ìœ¼ë¡œ, í”Œë ˆì´ì–´ëŠ” ìë™ìœ¼ë¡œ ë¹ˆ ìë¦¬ ì„ íƒ
            const randomPos = possiblePositions[Math.floor(Math.random() * possiblePositions.length)];
            jokerCard.placedSortValue = randomPos;
        }

        // =========================================================
        // íŒ¨ ì •ë ¬
        // - ì¡°ì»¤ë¼ë¦¬ ë¶™ì–´ìˆìœ¼ë©´ í° ì¡°ì»¤ê°€ ì˜¤ë¥¸ìª½ìœ¼ë¡œ
        // =========================================================
        function sortHand(hand) {
            // ë¨¼ì € ê¸°ë³¸ ì •ë ¬
            hand.sort((a, b) => a.getSortValue() - b.getSortValue());

            // ì¡°ì»¤ ìœ„ì¹˜ ì¡°ì •: ì¡°ì»¤ë¼ë¦¬ ì¸ì ‘í•˜ë©´ í°ìƒ‰ì´ ì˜¤ë¥¸ìª½
            for (let i = 0; i < hand.length - 1; i++) {
                const curr = hand[i];
                const next = hand[i + 1];

                if (curr.isJoker() && next.isJoker()) {
                    // í‘ë°± ì¡°ì»¤ê°€ ë¶™ì–´ìˆëŠ” ê²½ìš°
                    if (curr.color === 'white' && next.color === 'black') {
                        // ìˆœì„œ ë°”ê¿ˆ
                        [hand[i], hand[i + 1]] = [hand[i + 1], hand[i]];
                    }
                }
            }

            return hand;
        }

        // =========================================================
        // ìƒˆ ê²Œì„ ì‹œì‘
        // =========================================================
        function startNewGame() {
            gameState.deck = initializeDeck();
            gameState.playerHand = [];
            gameState.aiHand = [];
            gameState.currentTurn = 'player';
            gameState.phase = 'draw';
            gameState.round = 1;
            gameState.drawnCard = null;
            gameState.gameOver = false;
            gameState.winner = null;

            // 4ì¥ì”© ë°°ë¶„
            for (let i = 0; i < 4; i++) {
                const playerCard = gameState.deck.pop();
                const aiCard = gameState.deck.pop();

                // ì¡°ì»¤ì¸ ê²½ìš° ìœ„ì¹˜ ê²°ì •
                if (playerCard.isJoker()) {
                    assignJokerPosition(gameState.playerHand, playerCard);
                }
                if (aiCard.isJoker()) {
                    assignJokerPosition(gameState.aiHand, aiCard);
                }

                gameState.playerHand.push(playerCard);
                gameState.aiHand.push(aiCard);
            }

            gameState.playerHand = sortHand(gameState.playerHand);
            gameState.aiHand = sortHand(gameState.aiHand);

            // ë¡œê·¸ ì´ˆê¸°í™” (í—¤ë”ëŠ” ìœ ì§€)
            const header = logPanel.querySelector('.log-header');
            logPanel.innerHTML = '';
            logPanel.appendChild(header);

            addLog('ğŸ® ìƒˆ ê²Œì„ ì‹œì‘!', 'info');
            addLog('ğŸ“Œ ì¹´ë“œë¥¼ ë½‘ì•„ ì¶”ë¦¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.', 'info');

            setAiBubble('ì•ˆë…•í•˜ì„¸ìš”! ê²Œì„ì„ ì‹œì‘í•˜ì£ . ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤.', 'thinking');

            updateUI();
            render();
        }

        // =========================================================
        // ì¹´ë“œ ë½‘ê¸°
        // =========================================================
        function drawCard(isPlayer) {
            if (gameState.deck.length === 0) {
                addLog('âš ï¸ ë±ì— ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤!', 'fail');
                return null;
            }

            const card = gameState.deck.pop();
            const hand = isPlayer ? gameState.playerHand : gameState.aiHand;

            // ì¡°ì»¤ì¸ ê²½ìš° ìœ„ì¹˜ ê²°ì •
            if (card.isJoker()) {
                assignJokerPosition(hand, card);
            }

            hand.push(card);

            if (isPlayer) {
                gameState.playerHand = sortHand(gameState.playerHand);
            } else {
                gameState.aiHand = sortHand(gameState.aiHand);
            }

            return card;
        }

        // =========================================================
        // ì¶”ë¦¬ ì‹¤í–‰
        // =========================================================
        function makeGuess(isPlayerGuessing, cardIndex, guessedNumber) {
            const targetHand = isPlayerGuessing ? gameState.aiHand : gameState.playerHand;
            const targetCard = targetHand[cardIndex];

            if (!targetCard || targetCard.revealed) {
                return false;
            }

            // ì¶”ë¦¬ íŒì •
            const actualNumber = targetCard.number;

            if (actualNumber === guessedNumber) {
                targetCard.revealed = true;

                const target = isPlayerGuessing ? 'AI' : 'í”Œë ˆì´ì–´';
                const displayNum = guessedNumber === JOKER_VALUE ? 'ì¡°ì»¤(-)' : guessedNumber;
                addLog(`âœ… ì¶”ë¦¬ ì„±ê³µ! ${target}ì˜ ${cardIndex + 1}ë²ˆ ì¹´ë“œ: ${displayNum}`, 'success');

                checkWinCondition();
                return true;
            } else {
                if (gameState.drawnCard) {
                    gameState.drawnCard.revealed = true;
                    const drawnDisplay = gameState.drawnCard.isJoker() ? 'ì¡°ì»¤(-)' : gameState.drawnCard.number;
                    addLog(`âŒ ì¶”ë¦¬ ì‹¤íŒ¨! ìƒˆ ì¹´ë“œ ê³µê°œ: ${drawnDisplay}`, 'fail');
                } else {
                    addLog('âŒ ì¶”ë¦¬ ì‹¤íŒ¨!', 'fail');
                }
                return false;
            }
        }

        // =========================================================
        // ìŠ¹ë¦¬ ì¡°ê±´ í™•ì¸
        // =========================================================
        function checkWinCondition() {
            const playerAllRevealed = gameState.playerHand.every(card => card.revealed);
            const aiAllRevealed = gameState.aiHand.every(card => card.revealed);

            if (aiAllRevealed) {
                gameState.gameOver = true;
                gameState.winner = 'player';
                addLog('ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ìŠ¹ë¦¬!', 'success');
                setAiBubble('ìœ¼ì•…! ì¡ŒìŠµë‹ˆë‹¤... ë‹¤ì‹œ í•œ íŒ í•˜ì‹¤ë˜ìš”?', 'fail');
            } else if (playerAllRevealed) {
                gameState.gameOver = true;
                gameState.winner = 'ai';
                addLog('ğŸ˜¢ AI ìŠ¹ë¦¬!', 'fail');
                setAiBubble('í›„í›„, ì œê°€ ì´ê²¼ë„¤ìš”! ë‹¤ìŒì—” ë” ì˜í•´ë³´ì„¸ìš”~', 'success');
            }

            if (gameState.gameOver) {
                gameState.phase = 'waiting';
                updateUI();
            }
        }

        // =========================================================
        // í„´ êµëŒ€
        // =========================================================
        function switchTurn() {
            gameState.currentTurn = gameState.currentTurn === 'player' ? 'ai' : 'player';
            gameState.phase = 'draw';
            gameState.drawnCard = null;
            gameState.round++;

            const turnName = gameState.currentTurn === 'player' ? 'í”Œë ˆì´ì–´' : 'AI';
            addLog(`ğŸ”„ ${turnName} í„´`, 'info');

            updateUI();

            if (gameState.currentTurn === 'ai' && !gameState.gameOver) {
                setAiBubble('ìŒ... ì œ ì°¨ë¡€êµ°ìš”. ì¹´ë“œë¥¼ ë½‘ê² ìŠµë‹ˆë‹¤.', 'thinking');
                setTimeout(aiTurn, 1200);
            }
        }

        // =========================================================
        // AI í„´ ë¡œì§
        // =========================================================
        function aiTurn() {
            if (gameState.gameOver) return;

            const drawnCard = drawCard(false);
            if (drawnCard) {
                addLog('ğŸ¤– AIê°€ ì¹´ë“œë¥¼ ë½‘ì•˜ìŠµë‹ˆë‹¤.', 'info');
                gameState.drawnCard = drawnCard;
                setAiBubble('ì¹´ë“œë¥¼ ë½‘ì•˜ìŠµë‹ˆë‹¤! ì´ì œ ì¶”ë¦¬ë¥¼ í•´ë³¼ê¹Œìš”...', 'thinking');
            }

            render();
            setTimeout(() => aiMakeGuess(), 1500);
        }

        // =========================================================
        // AI ì¶”ë¦¬ ë¡œì§
        // =========================================================
        function aiMakeGuess() {
            if (gameState.gameOver) return;

            // ìˆ¨ê²¨ì§„ í”Œë ˆì´ì–´ ì¹´ë“œ ì¸ë±ìŠ¤
            const hiddenIndices = [];
            gameState.playerHand.forEach((card, idx) => {
                if (!card.revealed) hiddenIndices.push(idx);
            });

            if (hiddenIndices.length === 0) {
                checkWinCondition();
                return;
            }

            // ëœë¤ ì¹´ë“œ ì„ íƒ
            const targetIdx = hiddenIndices[Math.floor(Math.random() * hiddenIndices.length)];

            // ê°€ëŠ¥í•œ ìˆ«ìë“¤ (ì¡°ì»¤ í¬í•¨)
            const usedNumbers = getRevealedNumbers();
            const possibleNumbers = [];

            // ì¡°ì»¤ ì²´í¬ (ê° ìƒ‰ë‹¹ 1ì¥)
            const jokerCount = usedNumbers.filter(n => n === JOKER_VALUE).length;
            if (jokerCount < 2) possibleNumbers.push(JOKER_VALUE);

            for (let i = 0; i <= 11; i++) {
                const count = usedNumbers.filter(n => n === i).length;
                if (count < 2) possibleNumbers.push(i);
            }

            const guessedNumber = possibleNumbers[Math.floor(Math.random() * possibleNumbers.length)];
            const guessDisplay = guessedNumber === JOKER_VALUE ? 'ì¡°ì»¤(-)' : guessedNumber;

            setAiBubble(`${targetIdx + 1}ë²ˆ ì¹´ë“œ... ${guessDisplay}ì¸ê°€ìš”?`, 'attack');
            addLog(`ğŸ¤– AI: ${targetIdx + 1}ë²ˆ â†’ ${guessDisplay}`, 'info');

            setTimeout(() => {
                const success = makeGuess(false, targetIdx, guessedNumber);
                render();

                if (success && !gameState.gameOver) {
                    setAiBubble('ë§ì•˜ë‹¤! í•œ ë²ˆ ë” ì¶”ë¦¬í• ê¹Œìš”?', 'success');
                    setTimeout(() => {
                        if (Math.random() > 0.4 && hiddenIndices.length > 1) {
                            aiMakeGuess();
                        } else {
                            setAiBubble('ì´ë²ˆì—” ì—¬ê¸°ê¹Œì§€. ë‹¹ì‹  ì°¨ë¡€ì…ë‹ˆë‹¤.', 'thinking');
                            switchTurn();
                        }
                    }, 1500);
                } else if (!gameState.gameOver) {
                    setAiBubble('ì•—, í‹€ë ¸ë„¤ìš”... ë‹¹ì‹  ì°¨ë¡€ì…ë‹ˆë‹¤.', 'fail');
                    setTimeout(switchTurn, 1000);
                }
            }, 800);
        }

        // =========================================================
        // ê³µê°œëœ ìˆ«ì ëª©ë¡
        // =========================================================
        function getRevealedNumbers() {
            const numbers = [];
            [...gameState.playerHand, ...gameState.aiHand].forEach(card => {
                if (card.revealed) numbers.push(card.number);
            });
            return numbers;
        }

        // =========================================================
        // AI ë§í’ì„  ì„¤ì •
        // =========================================================
        function setAiBubble(text, type = 'thinking') {
            aiBubble.textContent = text;
            aiBubble.className = 'ai-bubble ' + type;
        }

        // =========================================================
        // UI ì—…ë°ì´íŠ¸
        // =========================================================
        function updateUI() {
            const turnDisplay = document.getElementById('currentTurn');
            turnDisplay.textContent = gameState.currentTurn === 'player' ? 'í”Œë ˆì´ì–´' : 'AI';
            turnDisplay.className = 'info-value ' + (gameState.currentTurn === 'player' ? 'player-turn' : 'ai-turn');

            document.getElementById('roundNumber').textContent = gameState.round;
            document.getElementById('playerRevealed').textContent =
                gameState.playerHand.filter(c => c.revealed).length + '/' + gameState.playerHand.length;
            document.getElementById('aiRevealed').textContent =
                gameState.aiHand.filter(c => c.revealed).length + '/' + gameState.aiHand.length;
            document.getElementById('deckRemaining').textContent = gameState.deck.length;

            btnDrawCard.disabled = !(gameState.currentTurn === 'player' && gameState.phase === 'draw' && !gameState.gameOver);

            if (gameState.currentTurn === 'player' && gameState.phase === 'guess' && !gameState.gameOver) {
                guessPanel.classList.add('active');
                updateCardPositionSelect();
            } else {
                guessPanel.classList.remove('active');
            }
        }

        // =========================================================
        // ì¹´ë“œ ìœ„ì¹˜ ì„ íƒ ì—…ë°ì´íŠ¸
        // =========================================================
        function updateCardPositionSelect() {
            cardPositionSelect.innerHTML = '';
            gameState.aiHand.forEach((card, idx) => {
                if (!card.revealed) {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = `${idx + 1}ë²ˆ ì¹´ë“œ`;
                    cardPositionSelect.appendChild(option);
                }
            });
        }

        // =========================================================
        // ë¡œê·¸ ì¶”ê°€
        // =========================================================
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            entry.textContent = `[${time}] ${message}`;

            const header = logPanel.querySelector('.log-header');
            if (header && header.nextSibling) {
                logPanel.insertBefore(entry, header.nextSibling);
            } else {
                logPanel.appendChild(entry);
            }
        }

        // =========================================================
        // ë Œë”ë§
        // =========================================================
        function render() {
            ctx.fillStyle = '#1e272e';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            ctx.font = 'bold 14px Segoe UI';
            ctx.textAlign = 'center';

            // AI ì˜ì—­ (ìƒë‹¨)
            ctx.fillStyle = '#e94560';
            ctx.fillText('ğŸ¤– AI', CANVAS_WIDTH / 2, 25);
            renderHand(gameState.aiHand, 40, 40, false);

            // ë± (ì¤‘ì•™)
            renderDeck();

            // í”Œë ˆì´ì–´ ì˜ì—­ (í•˜ë‹¨)
            ctx.fillStyle = '#4ecca3';
            ctx.fillText('ğŸ‘¤ í”Œë ˆì´ì–´', CANVAS_WIDTH / 2, 305);
            renderHand(gameState.playerHand, 40, 320, true);

            if (gameState.gameOver) {
                renderGameOver();
            }
        }

        // =========================================================
        // íŒ¨ ë Œë”ë§
        // =========================================================
        function renderHand(hand, startX, startY, showNumbers) {
            const totalWidth = hand.length * (CARD_WIDTH + CARD_GAP) - CARD_GAP;
            const offsetX = (CANVAS_WIDTH - totalWidth) / 2;

            hand.forEach((card, idx) => {
                const x = offsetX + idx * (CARD_WIDTH + CARD_GAP);
                renderCard(card, x, startY, showNumbers);
            });
        }

        // =========================================================
        // ì¹´ë“œ ë Œë”ë§
        // =========================================================
        function renderCard(card, x, y, showNumber) {
            ctx.save();

            // ê·¸ë¦¼ì
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;

            // ì¹´ë“œ ë°°ê²½
            if (card.isJoker()) {
                // ì¡°ì»¤ëŠ” ê·¸ë¼ë°ì´ì…˜ ë°°ê²½
                const gradient = ctx.createLinearGradient(x, y, x + CARD_WIDTH, y + CARD_HEIGHT);
                if (card.color === 'black') {
                    gradient.addColorStop(0, '#2d3436');
                    gradient.addColorStop(1, '#636e72');
                } else {
                    gradient.addColorStop(0, '#dfe6e9');
                    gradient.addColorStop(1, '#b2bec3');
                }
                ctx.fillStyle = gradient;
            } else {
                ctx.fillStyle = card.color === 'black' ? '#2d3436' : '#dfe6e9';
            }

            ctx.strokeStyle = card.revealed ? '#e94560' : '#636e72';
            ctx.lineWidth = card.revealed ? 3 : 1;

            roundRect(ctx, x, y, CARD_WIDTH, CARD_HEIGHT, 6);
            ctx.fill();
            ctx.stroke();

            ctx.shadowColor = 'transparent';

            // ìˆ«ì/ì¡°ì»¤ í‘œì‹œ
            if (showNumber || card.revealed) {
                ctx.fillStyle = card.color === 'black' ? '#ffffff' : '#2d3436';
                ctx.font = card.isJoker() ? 'bold 28px Segoe UI' : 'bold 22px Segoe UI';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(card.getDisplayText(), x + CARD_WIDTH / 2, y + CARD_HEIGHT / 2);

                // ì¡°ì»¤ í‘œì‹œ (â˜…)
                if (card.isJoker()) {
                    ctx.font = '10px Segoe UI';
                    ctx.fillText('JOKER', x + CARD_WIDTH / 2, y + CARD_HEIGHT - 12);
                }
            } else {
                ctx.fillStyle = '#636e72';
                ctx.font = 'bold 24px Segoe UI';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('?', x + CARD_WIDTH / 2, y + CARD_HEIGHT / 2);
            }

            // ìƒ‰ìƒ í‘œì‹œì 
            ctx.fillStyle = card.color === 'black' ? '#000000' : '#ffffff';
            ctx.strokeStyle = '#636e72';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(x + CARD_WIDTH - 10, y + 10, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            ctx.restore();
        }

        // =========================================================
        // ë± ë Œë”ë§
        // =========================================================
        function renderDeck() {
            const deckX = CANVAS_WIDTH / 2 - CARD_WIDTH / 2;
            const deckY = 175;

            for (let i = 0; i < Math.min(3, gameState.deck.length); i++) {
                ctx.fillStyle = '#34495e';
                ctx.strokeStyle = '#4a6572';
                ctx.lineWidth = 1;
                roundRect(ctx, deckX - i * 2, deckY - i * 2, CARD_WIDTH, CARD_HEIGHT, 6);
                ctx.fill();
                ctx.stroke();
            }

            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 14px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText(`ğŸƒ ${gameState.deck.length}ì¥`, deckX + CARD_WIDTH / 2, deckY + CARD_HEIGHT + 18);
        }

        // =========================================================
        // ê²Œì„ ì˜¤ë²„ í™”ë©´
        // =========================================================
        function renderGameOver() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            ctx.fillStyle = gameState.winner === 'player' ? '#4ecca3' : '#e94560';
            ctx.font = 'bold 42px Segoe UI';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const msg = gameState.winner === 'player' ? 'ğŸ‰ ìŠ¹ë¦¬!' : 'ğŸ˜¢ íŒ¨ë°°!';
            ctx.fillText(msg, CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 - 20);

            ctx.fillStyle = '#ffffff';
            ctx.font = '16px Segoe UI';
            ctx.fillText('ìƒˆ ê²Œì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 + 30);
        }

        // ë‘¥ê·¼ ì‚¬ê°í˜•
        function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
        }

        // ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ =====
        btnNewGame.addEventListener('click', startNewGame);

        btnDrawCard.addEventListener('click', () => {
            if (gameState.phase !== 'draw' || gameState.currentTurn !== 'player') return;

            const card = drawCard(true);
            if (card) {
                gameState.drawnCard = card;
                const cardType = card.isJoker() ? 'ì¡°ì»¤(-)' : `${card.color === 'black' ? 'ê²€ì •' : 'í°ìƒ‰'} ${card.number}`;
                addLog(`ğŸƒ ì¹´ë“œ íšë“: ${cardType}`, 'info');
                gameState.phase = 'guess';
                updateUI();
                render();
            }
        });

        btnGuess.addEventListener('click', () => {
            const cardIdx = parseInt(cardPositionSelect.value);
            const guessedNum = parseInt(guessNumberSelect.value);
            const guessDisplay = guessedNum === JOKER_VALUE ? 'ì¡°ì»¤(-)' : guessedNum;

            addLog(`ğŸ” ì¶”ë¦¬: ${cardIdx + 1}ë²ˆ â†’ ${guessDisplay}`, 'info');

            const success = makeGuess(true, cardIdx, guessedNum);
            render();

            if (success && !gameState.gameOver) {
                updateCardPositionSelect();
                if (cardPositionSelect.options.length === 0) {
                    checkWinCondition();
                }
                setAiBubble('ì•—, ë§ì¶”ì…¨ë„¤ìš”...!', 'fail');
            } else if (!gameState.gameOver) {
                setAiBubble('í•˜í•˜, í‹€ë ¸ë„¤ìš”! ì œ ì°¨ë¡€ì…ë‹ˆë‹¤.', 'success');
                switchTurn();
            }

            updateUI();
        });

        btnPass.addEventListener('click', () => {
            addLog('â­ï¸ í„´ ë„˜ê¹€', 'info');
            setAiBubble('ì¢‹ì•„ìš”, ì œ ì°¨ë¡€êµ°ìš”!', 'thinking');
            switchTurn();
            render();
        });

        btnRules.addEventListener('click', () => rulesModal.classList.add('active'));
        closeRules.addEventListener('click', () => rulesModal.classList.remove('active'));
        rulesModal.addEventListener('click', (e) => {
            if (e.target === rulesModal) rulesModal.classList.remove('active');
        });

        // ìº”ë²„ìŠ¤ í´ë¦­ìœ¼ë¡œ ì¹´ë“œ ì„ íƒ
        canvas.addEventListener('click', (e) => {
            if (gameState.phase !== 'guess' || gameState.currentTurn !== 'player') return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = CANVAS_WIDTH / rect.width;
            const scaleY = CANVAS_HEIGHT / rect.height;
            const clickX = (e.clientX - rect.left) * scaleX;
            const clickY = (e.clientY - rect.top) * scaleY;

            // AI ì¹´ë“œ ì˜ì—­ (y: 40 ~ 125)
            if (clickY >= 40 && clickY <= 40 + CARD_HEIGHT) {
                const totalWidth = gameState.aiHand.length * (CARD_WIDTH + CARD_GAP) - CARD_GAP;
                const offsetX = (CANVAS_WIDTH - totalWidth) / 2;

                gameState.aiHand.forEach((card, idx) => {
                    const cardX = offsetX + idx * (CARD_WIDTH + CARD_GAP);
                    if (clickX >= cardX && clickX <= cardX + CARD_WIDTH && !card.revealed) {
                        cardPositionSelect.value = idx;
                    }
                });
            }
        });

        // ì´ˆê¸° ë Œë”ë§
        render();
        addLog('ğŸ´ ë‹¤ë¹ˆì¹˜ ì½”ë“œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!', 'info');
    </script>
</body>

</html>